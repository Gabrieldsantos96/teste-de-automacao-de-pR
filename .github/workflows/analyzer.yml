name: PR Summary (Free HuggingFace)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # histÃ³rico completo necessÃ¡rio para diff

      - name: Detectar branch base
        id: base
        run: |
          BASE_BRANCH=$(jq -r .pull_request.base.ref "$GITHUB_EVENT_PATH")
          echo "BASE_BRANCH=$BASE_BRANCH" >> $GITHUB_ENV

      - name: Buscar branch base
        run: git fetch origin $BASE_BRANCH

      - name: Gerar diff e lista de arquivos
        run: |
          echo "### Arquivos modificados:" > diff.txt
          git diff --name-only origin/$BASE_BRANCH...HEAD > files.txt
          cat files.txt >> diff.txt
          echo -e "\n### Diff completo:" >> diff.txt
          git diff origin/$BASE_BRANCH...HEAD >> diff.txt
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          cat diff.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Resumir PR com HuggingFace
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.HUGGINGFACE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"inputs\": \"VocÃª Ã© um revisor sÃªnior de Pull Requests e deve atuar como se fosse uma mistura de arquiteto de software e analista de negÃ³cios. Seu objetivo Ã© gerar um relatÃ³rio altamente detalhado e estruturado sobre as mudanÃ§as deste PR.\n\nInstruÃ§Ãµes para o relatÃ³rio:\n1. Resumo Executivo: explique o propÃ³sito do PR e impacto de negÃ³cio.\n2. Detalhamento das MudanÃ§as: descreva cada arquivo, novas features, contratos, APIs e alteraÃ§Ãµes existentes.\n3. Impacto no Sistema: riscos, performance, seguranÃ§a e escalabilidade.\n4. Qualidade do CÃ³digo & Melhorias: boas prÃ¡ticas, clareza, pontos de melhoria.\n5. Riscos e Pontos de AtenÃ§Ã£o: potenciais bugs, Ã¡reas que precisam de testes adicionais.\n\nDiff completo:\n${PR_DIFF}\"
            }" \
            https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2 \
            | jq -r '.[0].generated_text')

          echo "### ðŸ¤– Resumo do PR" > pr-summary.md
          echo "$RESPONSE" >> pr-summary.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file pr-summary.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
