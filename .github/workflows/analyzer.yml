name: PR Summary (Free HuggingFace)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # histÃ³rico completo necessÃ¡rio para diff

      - name: Detectar branch base
        id: base
        run: |
          BASE_BRANCH=$(jq -r .pull_request.base.ref "$GITHUB_EVENT_PATH")
          echo "BASE_BRANCH=$BASE_BRANCH" >> $GITHUB_ENV

      - name: Buscar branch base
        run: git fetch origin ${{ env.BASE_BRANCH }}

      - name: Gerar diff e lista de arquivos
        run: |
          echo "### Arquivos modificados:" > diff.txt
          git diff --name-only origin/${{ env.BASE_BRANCH }}...HEAD >> diff.txt
          echo -e "\n### Diff completo:" >> diff.txt
          git diff origin/${{ env.BASE_BRANCH }}...HEAD >> diff.txt
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          cat diff.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Resumir PR com HuggingFace
        run: |
          # Escapa o diff para JSON
          ESCAPED_DIFF=$(jq -Rs . <<< "$PR_DIFF")

          # Faz a requisiÃ§Ã£o para a API
          RAW_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.HUGGINGFACE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"inputs\": \"VocÃª Ã© um revisor sÃªnior de Pull Requests e deve gerar um relatÃ³rio detalhado sobre este PR.\nDiff completo: $ESCAPED_DIFF\"}" \
            https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2)

          # Mostra o retorno bruto para debug
          echo "=== RAW RESPONSE ==="
          echo "$RAW_RESPONSE"
          echo "==================="

          # Tenta extrair o texto gerado
          PARSED_RESPONSE=$(echo "$RAW_RESPONSE" | jq -r '.[0].generated_text // empty')
          echo "=== PARSED RESPONSE ==="
          echo "$PARSED_RESPONSE"

          # Salva no arquivo para comentar no PR
          echo "### ðŸ¤– Resumo do PR" > pr-summary.md
          echo "$PARSED_RESPONSE" >> pr-summary.md

          # Comenta no PR
          gh pr comment ${{ github.event.pull_request.number }} --body-file pr-summary.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
